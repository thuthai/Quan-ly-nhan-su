{% extends 'layout.html' %}

{% block title %}Quản lý bậc lương - Hệ thống quản lý nhân sự{% endblock %}

{% block header %}
<div class="row mb-4">
    <div class="col">
        <h2 class="display-6 mb-3">
            <i class="bi bi-currency-exchange me-2"></i>Quản lý bậc lương
        </h2>
        <p class="lead">Quản lý các bậc lương và hệ số lương trong hệ thống</p>
    </div>
    <div class="col-auto align-self-center">
        <a href="{{ url_for('create_salary_grade') }}" class="btn btn-primary">
            <i class="bi bi-plus-circle me-1"></i> Thêm bậc lương mới
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="card shadow-sm">
    <div class="card-header bg-light">
        <h5 class="card-title mb-0">Danh sách bậc lương</h5>
    </div>
    <div class="card-body">
        {% if salary_grades %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Mã bậc lương</th>
                            <th>Tên bậc lương</th>
                            <th>Hệ số cơ bản</th>
                            <th>Lương cơ sở (VNĐ)</th>
                            <th>Lương tính toán (VNĐ)</th>
                            <th>Mô tả</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for grade in salary_grades %}
                            <tr>
                                <td class="fw-bold">{{ grade.code }}</td>
                                <td>{{ grade.name }}</td>
                                <td>{{ grade.base_coefficient }}</td>
                                <td>{{ "{:,}".format(grade.base_salary) }}</td>
                                <td>{{ "{:,}".format(grade.calculated_salary) }}</td>
                                <td>{{ grade.description|truncate(50) }}</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{{ url_for('edit_salary_grade', id=grade.id) }}" class="btn btn-outline-primary">
                                            <i class="bi bi-pencil-square"></i>
                                        </a>
                                        <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal{{ grade.id }}">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                    
                                    <!-- Delete Confirmation Modal -->
                                    <div class="modal fade" id="deleteModal{{ grade.id }}" tabindex="-1" aria-labelledby="deleteModalLabel{{ grade.id }}" aria-hidden="true">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="deleteModalLabel{{ grade.id }}">Xác nhận xóa</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <p>Bạn có chắc chắn muốn xóa bậc lương <strong>{{ grade.name }} ({{ grade.code }})</strong>?</p>
                                                    <p class="text-danger">Lưu ý: Việc xóa có thể ảnh hưởng đến dữ liệu lương của nhân viên.</p>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                                                    <a href="{{ url_for('delete_salary_grade', id=grade.id) }}" class="btn btn-danger">Xóa</a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i> Chưa có bậc lương nào. Hãy thêm bậc lương mới.
            </div>
        {% endif %}
    </div>
</div>

<div class="card shadow-sm mt-4">
    <div class="card-header bg-light">
        <h5 class="card-title mb-0">Áp dụng bậc lương cho nhân viên</h5>
    </div>
    <div class="card-body">
        <div class="row mb-3">
            <div class="col-md-6">
                <a href="{{ url_for('create_employee_salary') }}" class="btn btn-success">
                    <i class="bi bi-plus-circle me-1"></i> Thiết lập bậc lương cho nhân viên
                </a>
            </div>
            <div class="col-md-6 text-md-end">
                <a href="{{ url_for('employee_salary_history') }}" class="btn btn-outline-primary">
                    <i class="bi bi-clock-history me-1"></i> Xem lịch sử thay đổi lương
                </a>
            </div>
        </div>
        
        {% if employee_salaries %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Mã NV</th>
                            <th>Họ và tên</th>
                            <th>Bậc lương</th>
                            <th>Hệ số lương</th>
                            <th>Hệ số phụ cấp</th>
                            <th>Tổng hệ số</th>
                            <th>Lương tính toán (VNĐ)</th>
                            <th>Ngày hiệu lực</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in employee_salaries %}
                            <tr>
                                <td>{{ item.employee.employee_code }}</td>
                                <td>
                                    <a href="{{ url_for('view_employee', id=item.employee.id) }}">
                                        {{ item.employee.full_name }}
                                    </a>
                                </td>
                                <td>{{ item.salary_grade.name }}</td>
                                <td>{{ item.salary_grade.base_coefficient }}</td>
                                <td>{{ item.additional_coefficient }}</td>
                                <td>{{ item.total_coefficient }}</td>
                                <td>{{ "{:,}".format(item.calculated_salary) }}</td>
                                <td>{{ item.effective_date.strftime('%d/%m/%Y') }}</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{{ url_for('edit_employee_salary', id=item.id) }}" class="btn btn-outline-primary">
                                            <i class="bi bi-pencil-square"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i> Chưa có thông tin lương cho nhân viên nào. Hãy thiết lập bậc lương cho nhân viên.
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}