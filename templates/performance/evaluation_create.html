{% extends "layout.html" %}

{% block title %}Tạo đánh giá hiệu suất mới{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h2 class="h5 mb-0">Tạo đánh giá hiệu suất mới</h2>
        </div>
        <div class="card-body">
            <form method="POST" class="row g-3 needs-validation" novalidate>
                {{ form.hidden_tag() }}
                
                <div class="col-md-6">
                    <label for="employee_id" class="form-label">{{ form.employee_id.label }} <span class="text-danger">*</span></label>
                    {{ form.employee_id(class="form-select", id="employee_id") }}
                    {% for error in form.employee_id.errors %}
                        <div class="text-danger">{{ error }}</div>
                    {% endfor %}
                </div>
                
                <div class="col-md-6">
                    <label for="evaluation_period" class="form-label">{{ form.evaluation_period.label }} <span class="text-danger">*</span></label>
                    {{ form.evaluation_period(class="form-select", id="evaluation_period") }}
                    {% for error in form.evaluation_period.errors %}
                        <div class="text-danger">{{ error }}</div>
                    {% endfor %}
                </div>
                
                <div class="col-md-6">
                    <label for="start_date" class="form-label">{{ form.start_date.label }} <span class="text-danger">*</span></label>
                    {{ form.start_date(class="form-control datepicker", id="start_date", placeholder="Chọn ngày bắt đầu") }}
                    {% for error in form.start_date.errors %}
                        <div class="text-danger">{{ error }}</div>
                    {% endfor %}
                </div>
                
                <div class="col-md-6">
                    <label for="end_date" class="form-label">{{ form.end_date.label }} <span class="text-danger">*</span></label>
                    {{ form.end_date(class="form-control datepicker", id="end_date", placeholder="Chọn ngày kết thúc") }}
                    {% for error in form.end_date.errors %}
                        <div class="text-danger">{{ error }}</div>
                    {% endfor %}
                </div>
                
                <div class="col-12">
                    <label for="comments" class="form-label">{{ form.comments.label }}</label>
                    {{ form.comments(class="form-control", id="comments", rows="3", placeholder="Nhập nhận xét tổng quát") }}
                    {% for error in form.comments.errors %}
                        <div class="text-danger">{{ error }}</div>
                    {% endfor %}
                </div>
                
                <div class="col-md-6">
                    <label for="strengths" class="form-label">{{ form.strengths.label }}</label>
                    {{ form.strengths(class="form-control", id="strengths", rows="3", placeholder="Nhập điểm mạnh của nhân viên") }}
                    {% for error in form.strengths.errors %}
                        <div class="text-danger">{{ error }}</div>
                    {% endfor %}
                </div>
                
                <div class="col-md-6">
                    <label for="areas_for_improvement" class="form-label">{{ form.areas_for_improvement.label }}</label>
                    {{ form.areas_for_improvement(class="form-control", id="areas_for_improvement", rows="3", placeholder="Nhập lĩnh vực cần cải thiện") }}
                    {% for error in form.areas_for_improvement.errors %}
                        <div class="text-danger">{{ error }}</div>
                    {% endfor %}
                </div>
                
                <div class="col-12">
                    <label for="goals_for_next_period" class="form-label">{{ form.goals_for_next_period.label }}</label>
                    {{ form.goals_for_next_period(class="form-control", id="goals_for_next_period", rows="3", placeholder="Nhập mục tiêu cho kỳ tiếp theo") }}
                    {% for error in form.goals_for_next_period.errors %}
                        <div class="text-danger">{{ error }}</div>
                    {% endfor %}
                </div>
                
                <div class="d-flex justify-content-between mt-3">
                    <a href="{{ url_for('performance_evaluations') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-1"></i>Quay lại
                    </a>
                    <div>
                        <button type="submit" name="save_draft" class="btn btn-outline-primary me-2">
                            <i class="bi bi-save me-1"></i>Lưu nháp
                        </button>
                        <button type="submit" name="submit" class="btn btn-primary">
                            <i class="bi bi-send me-1"></i>Tiếp tục điền điểm
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize datepickers
        flatpickr('.datepicker', {
            dateFormat: 'Y-m-d',
            locale: 'vn',
            altInput: true,
            altFormat: 'd/m/Y',
            allowInput: true
        });
        
        // Set default dates based on period selection
        const periodSelect = document.getElementById('evaluation_period');
        const startDatePicker = document.getElementById('start_date')._flatpickr;
        const endDatePicker = document.getElementById('end_date')._flatpickr;
        
        periodSelect.addEventListener('change', function() {
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth();
            
            switch(this.value) {
                case 'MONTHLY':
                    // Current month
                    startDatePicker.setDate(new Date(currentYear, currentMonth, 1));
                    endDatePicker.setDate(new Date(currentYear, currentMonth + 1, 0));
                    break;
                case 'QUARTERLY':
                    // Current quarter
                    const quarter = Math.floor(currentMonth / 3);
                    startDatePicker.setDate(new Date(currentYear, quarter * 3, 1));
                    endDatePicker.setDate(new Date(currentYear, (quarter + 1) * 3, 0));
                    break;
                case 'BIANNUAL':
                    // Current half year
                    const halfYear = Math.floor(currentMonth / 6);
                    startDatePicker.setDate(new Date(currentYear, halfYear * 6, 1));
                    endDatePicker.setDate(new Date(currentYear, (halfYear + 1) * 6, 0));
                    break;
                case 'ANNUAL':
                    // Current year
                    startDatePicker.setDate(new Date(currentYear, 0, 1));
                    endDatePicker.setDate(new Date(currentYear, 11, 31));
                    break;
            }
        });
        
        // Trigger change to initialize dates if a period is already selected
        if (periodSelect.value) {
            periodSelect.dispatchEvent(new Event('change'));
        }
    });
</script>
{% endblock %}