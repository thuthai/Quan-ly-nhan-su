{% extends "layout.html" %}

{% block title %}Thống kê - Hệ thống Quản lý Nhân sự{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="mb-0">
                <i class="bi bi-bar-chart-fill me-2"></i>Thống kê
            </h1>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-3 mb-4">
        <div class="card dashboard-card bg-primary">
            <div class="card-body text-center">
                <i class="bi bi-people-fill mb-3 text-white" style="font-size: 2.5rem;"></i>
                <h2 class="dashboard-number text-white" style="text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5); font-weight: 700;">{{ overall_stats.total_employees }}</h2>
                <p class="card-text text-white" style="text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5); font-weight: 600;">Tổng số nhân viên</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-4">
        <div class="card dashboard-card bg-success">
            <div class="card-body text-center">
                <i class="bi bi-building-fill mb-3 text-white" style="font-size: 2.5rem;"></i>
                <h2 class="dashboard-number text-white" style="text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5); font-weight: 700;">{{ overall_stats.total_departments }}</h2>
                <p class="card-text text-white" style="text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5); font-weight: 600;">Tổng số phòng ban</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-4">
        <div class="card dashboard-card bg-warning">
            <div class="card-body text-center">
                <i class="bi bi-calendar-x-fill mb-3 text-white" style="font-size: 2.5rem;"></i>
                <h2 class="dashboard-number text-white" style="text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5); font-weight: 700;">{{ overall_stats.leave_requests }}</h2>
                <p class="card-text text-white" style="text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5); font-weight: 600;">Yêu cầu nghỉ phép</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-4">
        <div class="card dashboard-card bg-danger">
            <div class="card-body text-center">
                <i class="bi bi-exclamation-triangle-fill mb-3 text-white" style="font-size: 2.5rem;"></i>
                <h2 class="dashboard-number text-white" style="text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5); font-weight: 700;">{{ overall_stats.expiring_contracts }}</h2>
                <p class="card-text text-white" style="text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5); font-weight: 600;">Hợp đồng sắp hết hạn</p>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6 mb-4">
        <div class="card dashboard-card h-100">
            <div class="card-body">
                <h5 class="card-title mb-4">Phân bố nhân viên theo phòng ban</h5>
                <div style="height: 300px;">
                    <canvas id="departmentChart" data-departments="{{ dept_stats|tojson }}"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-4">
        <div class="card dashboard-card h-100">
            <div class="card-body">
                <h5 class="card-title mb-4">Phân bố giới tính</h5>
                <div style="height: 300px;">
                    <canvas id="genderChart" data-gender="{{ gender_stats|tojson }}"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card dashboard-card">
            <div class="card-body">
                <h5 class="card-title mb-4">Biểu đồ chấm công trong 30 ngày gần đây</h5>
                <div style="height: 300px;">
                    <canvas id="attendanceChart" data-attendance="{{ attendance_stats|tojson }}"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-4 mb-4">
        <div class="card dashboard-card h-100">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Phòng ban đông nhất</h5>
            </div>
            <div class="card-body">
                {% set max_dept = {'name': '', 'count': 0} %}
                {% for dept in dept_stats %}
                    {% if dept.count > max_dept.count %}
                        {% set _ = max_dept.update({'name': dept.name, 'count': dept.count}) %}
                    {% endif %}
                {% endfor %}
                
                <div class="text-center py-4">
                    <h2 class="mb-3">{{ max_dept.name }}</h2>
                    <p class="lead mb-0">{{ max_dept.count }} nhân viên</p>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-4">
        <div class="card dashboard-card h-100">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">Truy cập nhanh</h5>
            </div>
            <div class="card-body">
                <div class="list-group">
                    <a href="{{ url_for('employees') }}" class="list-group-item list-group-item-action">
                        <i class="bi bi-people-fill me-2"></i>Quản lý nhân viên
                    </a>
                    <a href="{{ url_for('departments') }}" class="list-group-item list-group-item-action">
                        <i class="bi bi-building-fill me-2"></i>Quản lý phòng ban
                    </a>
                    <a href="{{ url_for('attendance_report') }}" class="list-group-item list-group-item-action">
                        <i class="bi bi-calendar-check-fill me-2"></i>Báo cáo chấm công
                    </a>
                    <a href="{{ url_for('leave_requests') }}" class="list-group-item list-group-item-action">
                        <i class="bi bi-calendar-x-fill me-2"></i>Quản lý nghỉ phép
                    </a>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-4">
        <div class="card dashboard-card h-100">
            <div class="card-header bg-warning">
                <h5 class="mb-0 text-white" style="text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5); font-weight: 600;">Xuất báo cáo</h5>
            </div>
            <div class="card-body">
                <p class="card-text">Xuất dữ liệu nhân viên và chấm công để phân tích.</p>
                <div class="d-grid gap-3">
                    <form id="export-employees-form" action="{{ url_for('export_employees') }}" method="get">
                        <button type="button" class="btn btn-outline-primary w-100 btn-export" data-export-target="employees">
                            <i class="bi bi-file-earmark-excel me-2"></i>Xuất danh sách nhân viên
                        </button>
                    </form>
                    <a href="{{ url_for('attendance_report') }}" class="btn btn-outline-info w-100">
                        <i class="bi bi-file-earmark-text me-2"></i>Xuất báo cáo chấm công
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
<script src="{{ url_for('static', filename='js/export.js') }}"></script>
{% endblock %}
